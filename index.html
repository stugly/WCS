<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <link rel="stylesheet" href="https://stugly.github.io/substation/style.css">
    <style>
      :root { --primary-color: var(--line-green); }
      body { padding: 15px; background-color: #f4f7f6; }
      .form-card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
      .preview-box { width: 100%; max-width: 200px; margin-top: 10px; border-radius: 8px; display: none; }
      .btn-submit { background-color: var(--line-green) !important; width: 100%; padding: 12px; font-size: 1.1rem; }
    </style>
  </head>
  <body>
    <div class="container form-card">
      <h2 style="color: var(--line-green); text-align: center;">üåø ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≥‡∏à‡∏±‡∏î‡∏ß‡∏±‡∏ä‡∏û‡∏∑‡∏ä</h2>
      <hr>
      <form id="weedForm">
        <label>‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô (UID):</label>
        <input type="text" name="uid" id="uid" required placeholder="‡πÄ‡∏ä‡πà‡∏ô 001">

        <label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏µ:</label>
        <select name="station" id="stationSelect" required>
          <option value="">-- ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏ñ‡∏≤‡∏ô‡∏µ --</option>
        </select>

        <label>‡∏£‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏á‡∏≤‡∏ô:</label>
        <select name="round" required>
          <option value="1">‡∏£‡∏≠‡∏ö‡∏ó‡∏µ‡πà 1 (‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå)</option>
          <option value="2">‡∏£‡∏≠‡∏ö‡∏ó‡∏µ‡πà 2 (‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô)</option>
          <option value="3">‡∏£‡∏≠‡∏ö‡∏ó‡∏µ‡πà 3 (‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô)</option>
          <option value="4">‡∏£‡∏≠‡∏ö‡∏ó‡∏µ‡πà 4 (‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°)</option>
          <option value="5">‡∏£‡∏≠‡∏ö‡∏ó‡∏µ‡πà 5 (‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°)</option>
          <option value="6">‡∏£‡∏≠‡∏ö‡∏ó‡∏µ‡πà 6 (‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°)</option>
        </select>

        <div style="margin-top: 15px;">
          <label>üì∑ ‡∏£‡∏π‡∏õ‡∏Å‡πà‡∏≠‡∏ô‡∏ó‡∏≥ (Before):</label>
          <input type="file" name="fileBefore" accept="image/*" required id="imgBefore">
        </div>

        <div style="margin-top: 15px; margin-bottom: 20px;">
          <label>üì∑ ‡∏£‡∏π‡∏õ‡∏´‡∏•‡∏±‡∏á‡∏ó‡∏≥ (After):</label>
          <input type="file" name="fileAfter" accept="image/*" required id="imgAfter">
        </div>

        <button type="submit" class="btn-submit" id="submitBtn">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
      </form>
      <div id="loader" style="display:none; text-align:center; margin-top:10px;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î...</div>
    </div>

    <script>
      // ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏ñ‡∏≤‡∏ô‡∏µ‡∏à‡∏≤‡∏Å‡∏ä‡∏µ‡∏ï Stations
      google.script.run.withSuccessHandler(stations => {
        const select = document.getElementById('stationSelect');
        select.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏µ --</option>';
        stations.forEach(s => {
          let opt = document.createElement('option');
          opt.value = s; opt.innerHTML = s;
          select.appendChild(opt);
        });
      }).getStations();

      // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°
      const form = document.getElementById('weedForm');
      form.onsubmit = function(e) {
        e.preventDefault();
        document.getElementById('submitBtn').disabled = true;
        document.getElementById('loader').style.display = 'block';

        const fileBefore = document.getElementById('imgBefore').files[0];
        const fileAfter = document.getElementById('imgAfter').files[0];

        // ‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏õ‡πá‡∏ô Blob ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏ù‡∏±‡πà‡∏á Server
        const readerBefore = new FileReader();
        readerBefore.onload = function(e1) {
          const readerAfter = new FileReader();
          readerAfter.onload = function(e2) {
            const formData = {
              uid: document.getElementById('uid').value,
              station: form.station.value,
              round: form.round.value,
              fileBefore: {
                data: e1.target.result.split(',')[1],
                mimeType: fileBefore.type,
                name: fileBefore.name
              },
              fileAfter: {
                data: e2.target.result.split(',')[1],
                mimeType: fileAfter.type,
                name: fileAfter.name
              }
            };
            
            google.script.run.withSuccessHandler(res => {
              alert(res.message);
              if(res.status === "success") form.reset();
              document.getElementById('submitBtn').disabled = false;
              document.getElementById('loader').style.display = 'none';
            }).processForm(formData);
          };
          readerAfter.readAsDataURL(fileAfter);
        };
        readerBefore.readAsDataURL(fileBefore);
      };
    </script>
  </body>
</html>
